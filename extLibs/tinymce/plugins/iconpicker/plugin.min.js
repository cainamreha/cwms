tinymce.PluginManager.add('iconpicker',function(editor,url){var iconclass="icons icon-";var defaultIconpicker=[];var iconpicker=editor.settings.iconpicker||defaultIconpicker,fullIconpickerList=editor.settings.extended_iconpicker?iconpicker.concat(editor.settings.extended_iconpicker):iconpicker;function getHtml(){var iconpickerHtml;iconpickerHtml='<table role="presentation" class="mce-grid mce-grid-iconpicker">';tinymce.each(fullIconpickerList,function(row){iconpickerHtml+='<tr>';tinymce.each(row,function(icon){iconpickerHtml+='<td><a href="#" data-mce-iconclass="'+icon.iconclass+'" tabindex="-1" title="'+icon.title+'"><span class="'+icon.iconclass+'"></span></a></td>';});iconpickerHtml+='</tr>';});iconpickerHtml+='</table>';return iconpickerHtml;}function concatArray(array){var each=tinymce.each,result=[];each(array,function(item){result=result.concat(item);});return result.length>0?result:array;}function findAndReplaceDOMText(regex,node,replacementNode,captureGroup,schema){var m,matches=[],text,count=0,doc;var blockElementsMap,hiddenTextElementsMap,shortEndedElementsMap;doc=node.ownerDocument;blockElementsMap=schema.getBlockElements();hiddenTextElementsMap=schema.getWhiteSpaceElements();shortEndedElementsMap=schema.getShortEndedElements();function getMatchIndexes(m,captureGroup){captureGroup=captureGroup||0;var index=m.index;if(captureGroup>0){var cg=m[captureGroup];index+=m[0].indexOf(cg);m[0]=cg;}return[index,index+m[0].length,[m[0]]];}function getText(node){var txt;if(node.nodeType===3){return node.data;}if(hiddenTextElementsMap[node.nodeName]&&!blockElementsMap[node.nodeName]){return'';}txt='';if(blockElementsMap[node.nodeName]||shortEndedElementsMap[node.nodeName]){txt+='\n';}if((node=node.firstChild)){do{txt+=getText(node);}while((node=node.nextSibling));}return txt;}function stepThroughMatches(node,matches,replaceFn){var startNode,endNode,startNodeIndex,endNodeIndex,innerNodes=[],atIndex=0,curNode=node,matchLocation=matches.shift(),matchIndex=0;out:while(true){if(blockElementsMap[curNode.nodeName]||shortEndedElementsMap[curNode.nodeName]){atIndex++;}if(curNode.nodeType===3){if(!endNode&&curNode.length+atIndex>=matchLocation[1]){endNode=curNode;endNodeIndex=matchLocation[1]-atIndex;}else if(startNode){innerNodes.push(curNode);}if(!startNode&&curNode.length+atIndex>matchLocation[0]){startNode=curNode;startNodeIndex=matchLocation[0]-atIndex;}atIndex+=curNode.length;}if(startNode&&endNode){curNode=replaceFn({startNode:startNode,startNodeIndex:startNodeIndex,endNode:endNode,endNodeIndex:endNodeIndex,innerNodes:innerNodes,match:matchLocation[2],matchIndex:matchIndex});atIndex-=(endNode.length-endNodeIndex);startNode=null;endNode=null;innerNodes=[];matchLocation=matches.shift();matchIndex++;if(!matchLocation){break;}}else if((!hiddenTextElementsMap[curNode.nodeName]||blockElementsMap[curNode.nodeName])&&curNode.firstChild){curNode=curNode.firstChild;continue;}else if(curNode.nextSibling){curNode=curNode.nextSibling;continue;}while(true){if(curNode.nextSibling){curNode=curNode.nextSibling;break;}else if(curNode.parentNode!==node){curNode=curNode.parentNode;}else{break out;}}}}function genReplacer(nodeName){var makeReplacementNode;if(typeof nodeName!='function'){var stencilNode=nodeName.nodeType?nodeName:doc.createElement(nodeName);makeReplacementNode=function(){var clone=stencilNode.cloneNode(false);return clone;};}else{makeReplacementNode=nodeName;}return function replace(range){var before,after,parentNode,startNode=range.startNode,endNode=range.endNode;if(startNode===endNode){var node=startNode;parentNode=node.parentNode;if(range.startNodeIndex>0){before=doc.createTextNode(node.data.substring(0,range.startNodeIndex));parentNode.insertBefore(before,node);}var el=makeReplacementNode();parentNode.insertBefore(el,node);if(range.endNodeIndex<node.length){after=doc.createTextNode(node.data.substring(range.endNodeIndex));parentNode.insertBefore(after,node);}node.parentNode.removeChild(node);return el;}};}text=getText(node);if(!text){return;}while((m=regex.exec(text))){matches.push(getMatchIndexes(m,captureGroup));}if(matches.length){count=matches.length;stepThroughMatches(node,matches,genReplacer(replacementNode));}return count;}function onButtonClick(){var self=this;showDialog();}function showDialog(imageList){var win,data={},dom=editor.dom,icoElm=editor.selection.getNode();var classListCtrl;function onSubmitForm(){data=tinymce.extend(data,win.toJSON());data={"class":'cc-iconcontainer '+data["class"]};editor.undoManager.transact(function(){if(icoElm){dom.setAttribs(icoElm,data);}});}if(icoElm.nodeName=='SPAN'&&!icoElm.getAttribute('data-mce-object')&&!icoElm.getAttribute('data-mce-placeholder')){data={"class":dom.getAttrib(icoElm,'class').replace(/(cc-iconcontainer) ?/,"")};}else{icoElm=null;return false;}function buildListItems(inputList,itemCallback,startItems){function appendItems(values,output){output=output||[];tinymce.each(values,function(item){var menuItem={text:item.text||item.title};if(item.menu){menuItem.menu=appendItems(item.menu);}else{menuItem.value=item.value;itemCallback(menuItem);}output.push(menuItem);});return output;}return appendItems(inputList,startItems||[]);}if(editor.settings.icon_class_list){classListCtrl={name:'class',type:'listbox',label:'Class',values:buildListItems(editor.settings.icon_class_list,function(item){if(item.value){item.textStyle=function(){return editor.formatter.getCssText({inline:'span',classes:['cc-iconcontainer '+item.value]});};}})};}var generalFormItems=[];generalFormItems.push(classListCtrl);win=editor.windowManager.open({title:'Icon',data:data,body:generalFormItems,onSubmit:onSubmitForm});}editor.addButton('iconpicker',{type:'colorbutton',format:'forecolor',icon:'preview',stateSelector:'span.cc-iconcontainer',panel:{autohide:true,html:getHtml,onclick:function(e){e.preventDefault();var linkElm=editor.dom.getParent(e.target,'a');if(linkElm){var icoSel=$(tinyMCE.activeEditor.selection.getContent());var newIco='<span class="'+linkElm.getAttribute('data-mce-iconclass')+'" role="icon"><!-- cc-icon --></span>';if(icoSel.hasClass('cc-iconcontainer')){newIco=icoSel.html(newIco).prop('outerHTML')+'&nbsp;';}else{newIco='<span class="cc-iconcontainer">'+newIco+'</span>&nbsp;';}editor.insertContent(newIco);this.hide();}}},onclick:onButtonClick,tooltip:'Iconpicker'});editor.on('init',function(){var cssURL=url+'/css/iconpicker.css';if(editor.dom&&typeof(editor.dom.loadCSS)=="function"){editor.dom.loadCSS(cssURL);}else{head.load({tmceiconpicker:cssURL});}});editor.on("mousedown",function(e){e=e.target;var icoItem=$(e).closest('.cc-iconcontainer');var editArea=icoItem.closest('.mce-content-body');if(icoItem.length){var icoFillPH=icoItem.children('.icon-selection-fill');var fillSpan='<span class="icon-selection-fill">&nbsp;</span>';if(!icoFillPH.length){icoItem.prepend(fillSpan);icoItem.append(fillSpan);}icoItem.on('mouseup',function(e){window.setTimeout(function(){editor.selection.setCursorLocation(icoItem[0]);editor.selection.select(icoItem[0]);},1);});}});editor.on('nodeChange',function(e){var editArea=$(e.element).closest('.mce-content-body');var icoItem=$(e.element).closest('.cc-iconcontainer');editArea.find('.cc-iconcontainer').removeAttr("data-mce-selected");if(icoItem.length){icoItem.attr('data-mce-selected',1);}});editor.on('SaveContent',function(ed){var fillSpanRx=/\s*<span class="icon-selection-fill">\s*&nbsp;\s*<\/span>\s*/;ed.content=ed.content.replace(RegExp(fillSpanRx,"g"),"");$(ed.element).html(ed.content);});});