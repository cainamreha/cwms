/* theme script */

var conciseCMS			= conciseCMS || {regSess: false};
var cc					= conciseCMS;
var ln					= cc.ln || {};
//cc.domIsLoaded			= false;


// Define http root
cc.getHttpRoot	= function() {

	var root = document.location.protocol + '//' + document.location.host;
	if(document.location.host == "localhost"){
		root += '/' + document.location.pathname.split('/', 1)[1];
	}
	return root;
};
cc.httpRoot = cc.httpRoot || cc.getHttpRoot();


// load init js
head.ready('jquery', function(){
	head.load({ ccInitScript: cc.httpRoot + "/system/access/js/concise.init.min.js" }, function(){
		conciseCMS.fe	= true;
		cc.setLoadingImages(true);
	});
});



// getScrollOffsetTop
cc.getScrollOffsetTop = function(){
	return cc.isMobile ? 0 : Math.ceil($('.navbar-fixed-top').height()) || 45;
};


// scrollToElement
cc.scrollToElement = function(hash, speed, sDelay, once){

	if(!hash || !$(hash).length) {
		return false;
	}
	
	$('html,body').stop().delay(sDelay || 0).animate({ scrollTop: Math.ceil($(hash).offset().top)  - cc.scrollOffsetTop}, speed, 'swing', function(){
	
		// if fixed nav adjust scrollspy
		if($('.navbar-fixed-top').length){
			cc.scrollOffsetTop	= cc.getScrollOffsetTop();
			if($('.navbar-scrollspy').length){
				$('body').scrollspy({offset: parseInt(cc.scrollOffsetTop +20)});
				$('body').scrollspy('refresh');
			}
		}
		// repeat in case size has changed
		if(!once){
			cc.scrollToElement(hash, 300, 0, true);
		}
		$(hash).focus().blur();
	});
};


// Zu Anker scrollen bei Seitenaufruf mit Hashtag
cc.scrollOnLoad = function() {

	try {
		$(window).load(function(){
			var hash	= window.location.hash;
			cc.scrollToElement(hash, 600, 100);
		});
	} catch (err) {
		console.log(err);
		return false;
	}
};


head.ready(function(){

$(document).ready(function(){

	$('body').addClass('cc-domloaded');
	
	if(!cc.fe) {
		cc.domIsLoaded	= true;
	}

	cc.isMobile			= window.matchMedia("only screen and (max-width: 760px)").matches || false;
	cc.scrollOffsetTop	= cc.getScrollOffsetTop();
	cc.scrollOnLoad();

	// Container centered
	cc.adjustCenContHeight = function(resH){
		$('.container-centered').each(function(){
			var cenCon	= $(this);
			var parSec	= cenCon.parent();
			if(resH){
				parSec.css('min-height','');
			}
			parSec.css('min-height', Math.max(parSec.height(), cenCon.height()) + 'px');
			cenCon.children('.wow').one('webkitAnimationEnd oanimationend msAnimationEnd animationend', function(e){
				parSec.css('min-height', Math.max(parSec.height(), cenCon.height()) + 'px');
			});
		});
	};
	cc.adjustCenContHeight();
	
	$(window).resize(function(){
		cc.adjustCenContHeight(true);
	});

	// click blur
	$("body").on("click", "a", function(){
		$(this).blur();
	});

	// alerts
	head.ready("alerts", function(){
	
		// Buttonbeschriftung für jConfirm
		$.alerts.okButton = 'Ok';
		$.alerts.cancelButton = ln.cancel;
		$.alerts.dialogClass = 'ui-dialog ui-widget ui-widget-content ui-corner-all ui-front ui-dialog-buttons ui-draggable ui-resizable';
	});
	
	
	
	// Affix navbar
	if($('.navbar-affix').length){
		$(window).scrollTop(0); // Scroll to top first (in case there is hash) to get correct offset
		$('.navbar-affix').affix({
			offset: {
				top: $('.navbar-affix').offset().top
			}
		});
		$(".navbar-affix").on('affixed.bs.affix', function(){
			$(this).addClass('navbar-fixed-top');
		});
		$(".navbar-affix").on('affixed-top.bs.affix', function(){
			$(this).removeClass('navbar-fixed-top');
		});
	}
	
	
	// Scrollspy navbar
	if($('.navbar-scrollspy').length){
		$('body').scrollspy({
			target: '.navbar-scrollspy .navbar',
			offset: cc.scrollOffsetTop +20
		});
	}
	
	
	// Zu Anker scrollen
	$("body").on("click", "a[href^='#']:not(.up a[href='#top'], .scroll-no, .ui-tabs-anchor)", function() {
		if($(this).closest('[contenteditable]').length){
			return false;
		}
		var ancor = $(this).attr("href").split("#")[1];
		if(typeof(ancor) != "undefinded" && ancor != "" && $("#" + ancor).length){
			
			// Scroll to element
			cc.scrollToElement("#" + ancor, 600);
			
			// If navbar-collapse collapse nav
			var colNav	= $(this).closest('.navbar-collapse.in');
			if(colNav.length){
				colNav.closest('.navbar').find('.navbar-toggle')[0].click();
			}
			return false;
		}
	});

	
	// Nach oben Link anzeigen/ausblenden
	$(window).scroll(function () {
		if ($(this).scrollTop() > 100) {
			$('.navbar-large').removeClass('navbar-large').addClass('navbar-large-condensed');
			$('p.up').fadeIn(600);
		} else {
			$('.navbar-large-condensed').addClass('navbar-large').removeClass('navbar-large-condensed');
			$('p.up').fadeOut(600);
		}
	});
	
	// Zum Seitenanfang scrollen
	$("body").on("click", 'p.up', function() {
		$('body,html').animate({scrollTop: 0}, 600);
		return false;
	});

	
	// Funktion zum Zurücksetzen von Formularen
	$("#reset").click(function fieldRes() {
	
		$("select").children('option:first-child').attr("selected","selected"); 
		$('input').not('input[type="button"]').not('input[type="submit"]').not('input[type="reset"]').attr("value","");
		$("textarea").attr("value","");
	});
	
	
	// Platzhalter generieren in Formularen ohne Labels
	$(".cc-form-labelless").find("label[for]").each(function(i,e){
		var lab = $(e).text();
		var tag = $(e).attr("for");
		$("#" + tag).attr("placeholder",lab);
	});

	
	// Platzhalter in Formularen
	$("body").on("focus", "input[placeholder], textarea[placeholder]", function() {
		var ph	= $(this).attr('placeholder');
		$(this).attr('placeholder', '');
		$(this).blur(function(){
			$(this).attr('placeholder', ph);
		});
	});


	// TopHeader anzeigen
	$('body').on("mouseenter click", 'div#topHeader:not(.visible, .over)', function(e){
		e.preventDefault();
		e.stopPropagation();		
		$.showAccountMenu($(this));
	});

	
	// Einblenden der Loginbox (hover)
	$('div#container').on("mouseenter", "#accountMenu .gotoAdminPage, #accountMenu .loginButton, .logFormSmall", function(){
		var accDiv = $(this).closest('#account');
		var logDiv = accDiv.find(".logFormSmall");
		logDiv.stop(true,false).fadeIn(150);
	}).on("mouseleave", "#accountMenu .gotoAdminPage, #accountMenu .loginButton, .logFormSmall", function() {
		var accDiv = $(this).closest('#account');
		var logDiv = accDiv.find(".logFormSmall");
		if(logDiv.hasClass('show')){
			return false;
		}
		logDiv.stop(true,false).delay(600).fadeOut(200);
	});
	
	// Funktion zum dauerhaften Einblenden der Loginbox
	$('body').on("focus", "div.logFormSmall input", function() {
		var logDiv = $(this).closest("div.logFormSmall");
		var topDiv = logDiv.closest('#topHeader');
		topDiv.addClass('visible');
		logDiv.addClass('show');
		$('div#contentBox, div#footer').click(function(){
			logDiv.removeClass('show').trigger("mouseleave");
		});
	});
	
	// Funktion zum Ausblenden der Loginbox
	$('body').on("click", "a.loginButton", function(){
		var logDiv = $(this).parents("#accountMenu").siblings("div.logFormSmall");
		if(logDiv.hasClass('show')){
			logDiv.fadeOut(300, function(){ $(this).removeClass('show').removeAttr('style'); });
			return false;
		}
	});

	
	// Verringern des z-index von Elementen bei Vollbild (jPlayer)
	$('a.jp-full-screen').click(function(){
		$('div#header').css('z-index',0);
		$('div#right').css('display',"none");
		$('div#footer').css('display',"none");
	});
	$('a.jp-restore-screen').click(function(){
		$('div#header').css('z-index',100);
		$('div#right').css('display',"block");
		$('div#footer').css('display',"block");
	});
	

	// Funktion zum Erneuern des Captchas
	var capCount = 0;	
	$('body').on("click", '.caprel', function(e){

		e.preventDefault();

		capCount++;

		var targetUrl = $(this).attr('href');
		$('img.captcha').attr('src', targetUrl + '?rel=' + capCount);
		return false;
	});


	// Theme-Vorschaubilder einblenden bei Auswahl über Select
	$('select.themes option').on("bind, mouseenter", function(e){
			
		var theme = $(this).html();
		var themeImg = cc.httpRoot  + '/themes/' + theme + '/img/theme-preview-big.jpg';

		$(this).parents('div.selTheme').append('<div class="themePreview" style="top:' + e.pageY + 'px;"><img src="' + themeImg + '" /></div>');
				
	}).on("bind, mouseleave",
        	function(e){
			$('div.themePreview').remove();
	});


	// Löschen eines Inhaltelements bzw. von Kommentaren
	$('body').on('click', '.dataEditButtons *[data-action="delete"], .commentEditButtons *[data-action="delete"]', function(){
		var targetUrl = $(this).attr('data-url');
		var confMes = "Möchten Sie dieses Element wirklich löschen?";
		if(typeof(jConfirm) == "function"){
			jConfirm(confMes, ln.confirmtitle, function(result){
				if(result === true) {
					document.location.href = targetUrl;
				}
			});
		}else{
			if(confirm(confMes)){
				document.location.href = targetUrl;
			}
		}
		return false;
	});


	// Nachricht veröffentlichen
	$('body').on('click', '*[data-action="pubdata"]:not(.icon-loading)', function(){
		
		var elem		= $(this);
		var targetUrl	= elem.attr('data-url');
		
		if($.isFunction($.fn.loading)) {
			elem.loading();
		}
		
		$.ajax({
			url: targetUrl,
			success: function(ajax){
				if(ajax == "1"){
					elem.siblings('[data-action="pubdata"]:hidden').css('display','inline-block');
					elem.css('display','none');
				}else{
					jAlert(ln.dberror, ln.alerttitle);
				}
				if($.isFunction($.fn.loadingRemove)) {
					elem.loadingRemove();
				}
				return false;
			}
		});
		return false;
	});


	// Kommentare einblenden
	$('*[data-toggle]:not([data-context="navbar"],[data-context="accordion"],[data-context="modal"])').bind("click tab", function(){
		var target	= $(this).attr('data-toggle');
		$('#' + target).slideToggle("fast");
		return false;
	});
	$('#commentSection').blur(function(){
		$(this).children('div.comments').slideDown("fast");
		return false;
	});

	// Kommentar-Formular einblenden
	$('span.newComment').bind("click tab",function(){
		if($('#commentForm').length){
			$('#commentForm').slideToggle("fast");
			return false;
		}
	});
	
	
	// Newsfeed-Liste einblenden
	$('img#feed, div.cc-newsfeed div.close').click(function(){
		$('div.cc-newsfeed').slideToggle("fast");
		$(this).blur();
		return false;
	});
	

	// Tabs ein-/ausblenden
	if($('div.tabsWrapper').length){
	
		$().tab;
		$('.tabsWrapper li:first a').tab('show');
		$('.tabsWrapper a').click(function (e) {
			e.preventDefault()
			$(this).tab('show')
		});
	}

	
	// Zusätzliche Bestellposten einblenden
	$('button.addOrderEntry').click(function() {
		if($(this).siblings('li:visible').length)
			$(this).parent('ol').children('li:visible').next('li:hidden').show();
		if(!$(this).siblings('li:hidden').length) {
			$(this).hide();
		}
		return false;
	});


	// Wenn bei mehrstufigen Formularen auf formFlow geklickt wird
	$('*[data-formstep]').click(function() {							 
		var submitName = 'step_' + $(this).attr('data-formstep');
		$(this).parents('form').append('<input name="' + submitName + '" type="hidden" value="' + $(this).val() + '" />').find(".submit-next")[0].click();	 	
		return false;
    });


	// Wenn beim Bestellformular beim Schritt "überprüfen" ändern geklickt wird (oder auf formFlow)
	$('*[data-orderstep]').click(function() {							 
		var submitName = 'order_step' + $(this).attr('data-orderstep');
		$(this).append('<input name="' + submitName + '" type="hidden" value="edit" />').parents('form').submit();	 	
		return false;
    });
	
	
	// Benutzermeldung ausblenden
	//if($('.tempHint, div.cc-module > .notice, div#mainContent > .notice').length) {
	if($('.tempHint').length) {
		$('.tempHint').not('.empty, .permanent-notice').delay(3000).slideUp("medium", function(){ $(this).remove(); });
		return false;
	}

	
	// Live-Modus der Website ändern
	$('body').on("click", 'a.goLive', function(e) {

		e.preventDefault();
		e.stopPropagation();
		
		var element = $(this);
		var confmes	= element.attr('data-confirm');
		
		jConfirm(confmes, ln.confirmtitle, function(result){
		
			if(result === true){
			
				var targetUrl = element.attr('href');
				
				$.ajax({
					url: targetUrl + "&ajax=1"
				}).done(function(ajax){
					element.fadeOut(250, function(){
						$(this).remove();
					});
					jAlert(ajax, ln.alerttitle);
					return ajax;
				});
				return false;
			}
		});
	});
	
});


// Show/hide accountMenu
(function($){
	
	$.showAccountMenu = function(elem){
		
		if(elem.hasClass("visible")
		|| elem.find(".logFormSmall.visible").length
		){
			return false;
		}		
		
		elem.stop(true,false).addClass('over visible').css('height','0px').animate({height:'45px'}, 300, function(){ elem.addClass('visible'); });
		$("#accountMenu").fadeIn();
		$(".navbar-fixed-top, #header .fixedNav .navbar").animate({top:'45px'}, 300);
		$(".cc-fixed-top").animate({top:'+=45px'}, 300);
		$("div#container").animate({paddingTop:'45px'}, 300);
		
		var closeBtn	= $('<button class="btn btn-default btn-xs cc-accountmenu-close"><span class="icons icon-close"></span></button>');
		closeBtn.hide().delay(400).appendTo($("#accountMenu")).fadeIn(300);
		
		elem.find(".cc-accountmenu-close").click(function() {		
			$(this).fadeOut(100, function(){ $(this).remove(); });
			//elem.removeClass("over").trigger("mouseleave");
			elem.removeClass("over");
			$.hideAccountMenu(elem);
			elem.off("mouseenter");
		});

		return false;
	
	},
	
	$.hideAccountMenu = function(elem){
		
		if(elem.hasClass("over")
		|| elem.find(".logFormSmall.visible").length
		){
			return false;
		}
				
		elem.stop(true,false).addClass('over').slideUp(300, function(){
			elem.hide().delay(1000).removeClass('visible over').css('height','10px').show(1, function(){
				elem.on("mouseenter", function(e){
					e.preventDefault();
					e.stopPropagation();		
					$.showAccountMenu($(this));
				});
			});
		});
		$("#accountMenu").stop(true,false).fadeOut();
		$(".navbar-fixed-top, #header .fixedNav .navbar").stop(true,false).animate({top:'0'}, 300);
		$(".cc-fixed-top").stop(true,false).animate({top:'-=45px'}, 300);
		$("div#container").stop(true,false).animate({paddingTop:'0px'}, 300);
		return false;
	
	};
	
})(jQuery);

});
